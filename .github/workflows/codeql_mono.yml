name: FMS CodeQL Analysis

on:
  workflow_dispatch:

jobs:
  discover_projects:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: List C# Projects
      id: matrix_setup
      run: |
        # Find directories containing .csproj or .sln files
        projects=$(find . -type f \( -name "*.csproj" -o -name "*.sln" \) -exec dirname {} \; | sort -u)
        # Convert newlines to JSON array syntax for GitHub Actions matrix
        projects_json=$(echo "$projects" | jq -R . | jq -s .)
        projects_json='{projects_json:'${projects_json}'}'
        echo 'projects_json=$projects_json' >> '$GITHUB_OUTPUT'
        echo $projects_json

    outputs:
      projects_json: ${{ steps.matrix_setup.outputs.projects_json }}


  codeql-analysis:
    runs-on: ubuntu-latest
    needs: discover_projects
    strategy:
      matrix:
        project-path: ${{ fromJson(needs.discover_projects.outputs.projects_json) }}

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: 'csharp'

    - name: Run Build Job for CodeQL
      run: |
        echo "Building project in: ${{ matrix.project-path }}"
        dotnet build ${{ matrix.project-path }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
